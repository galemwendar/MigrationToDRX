@page "/main"
@using Radzen
@using Radzen.Blazor

<RadzenDialog />

<PageTitle>Миграция данных в DirectumRX</PageTitle>

<div class="page-background-main">
    <RadzenComponents />
    <div class="card">
    <div class="card-header"><h3>Импорт из Excel</h3></div>
    <div class="card-body">
    
    <div class="row">
        <div class="col col-md-7">
            @* Выбор файла *@
            <label class="file-upload-label">Excel файл</label>
            <div class="file-upload-container mb-3">
        
                <RadzenUpload Accept=".xlsx,.xls,.odf,.ods,.csv"
                              Multiple="false"
                              ChooseText="Выбрать..."
                              Change="@OnFileUpload"
                              class="file-upload-control" />
                              
            </div>
        </div>
        <div class="col col-md-5">
            @* Выбор операции *@
            <div class="mb-3">
                <label class="form-label">Операция</label>
                <RadzenDropDown Data="@OperationItems"
                                @bind-Value="SelectedOperation"
                                Change="OnSelectedOperationChanged"
                                Placeholder="Выберите операцию с данными..."
                                Style="width:100%"
                                ValueProperty="Value"
                                TextProperty="DisplayName">
                </RadzenDropDown>

                <RadzenRequiredValidator TValue="string" Required="true" Text="Операция должна быть выбрана" />
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col col-md-7">
            @* Выбор сущности     *@
            <div class="mb-3">
                <label class="form-label">Сущность в Odata</label>
                <RadzenDropDown TextProperty="Name"
                                Data="@EntitySets"
                                @bind-Value="SelectedEntitySet"
                                Placeholder="Выберите сущность..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                AllowClear="true"
                                AllowFiltering="true"
                                Style="width:100%"
                                Change="OnSelectedEntitySetChanged">
                </RadzenDropDown>

                <RadzenRequiredValidator TValue="string" Required="true" Text="Сущность должна быть выбрана" />
            </div>
        </div>
        <div class="col col-md-5">
            @* Выбор ключа для всех связанных сущностей *@
            <div class="mb-3">
                <label class="form-label">Поиск связанных сущностей по:</label>
                <RadzenDropDown Data="@SearchEntityByList"
                                @bind-Value="SearchCriteria"
                                Placeholder="Выберите из списка..."
                                Style="width:100%"
                                ValueProperty="Value"
                                TextProperty="DisplayName">
                </RadzenDropDown>

                <RadzenRequiredValidator TValue="string" Required="true" Text="Критерий поиска должен быть выбран" />
            </div>

        </div>
    </div>
    
    <div class="row">
        <div class="col col-md-7">
            @* Контрол появляется только в том случае, если у выбранной сущности есть свойства-коллекции 
            и выбрана одна из операций работы со свойствами-коллекциями *@
            @if(CollectionProperties.Any() && (SelectedOperation == Data.Enums.OdataOperation.AddEntityToCollection || SelectedOperation == Data.Enums.OdataOperation.UpdateEntityInCollection))
            {
                @* Выбор свойства - коллекции     *@
                <div class="mb-3">
                    <label class="form-label">Свойство - коллекция</label>
                    <RadzenDropDown TextProperty="Name"
                                    Data="@CollectionProperties"
                                    @bind-Value="SelectedCollectionProperty"
                                    Placeholder="Выберите сущность..."
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    AllowClear="true"
                                    AllowFiltering="true"
                                    Style="width:100%"
                                    Change="OnSelectedCollectionPropertyChanged">
                    </RadzenDropDown>
                </div>
            }

        </div>
        <div class="col col-md-5">
            <!-- 📊 Количество строк -->
            <div class="mb-3">
                <h5> Количество строк, которые будут обработаны за одну операцию</h5>
                <div class="d-flex align-items-center mb-2" style="gap:10px;">
                    <RadzenCheckBox @bind-Value="UploadAllRows" TValue="bool" />
                    <label>Обработать все строки</label>
                    <RadzenCheckBox @bind-Value="ForceUploadProcessedRows" TValue="bool" />
                    <label>В том числе уже обработанные</label>
                </div>
                <RadzenNumeric @bind-Value="RowsToUpload"
                               Min="1"
                               Max="@PreviewRows.Count"
                               Disabled="@UploadAllRows"
                               Style="width:120px;" 
                               Placeholder="Количество" />
            </div>
        </div>
    </div>
    
    @* Кнопки валидации и отправки на сервер    *@
    <div class="mb-3 d-flex justify-content-between w-60">
        <div>

            <button class="btn btn-outline-secondary mx-1"
                @onclick="Validate"
                disabled="@(ColumnMappings.Any(m => m.Value != null) == false)">
                Проверить
            </button>

            <button class="btn btn-primary mx-1"
                    @onclick="Upload"
                    disabled="@(ColumnMappings.Any(m => m.Value != null) == false)">
                Отправить
            </button>


        </div>

        <button class="btn btn-outline-secondary mx-1"
                @onclick="DownloadExcel"
                disabled="@(ColumnMappings.Any(m => m.Value != null) == false)">
            Скачать отчет
        </button>

    </div>


    @if (PreviewRows.Any())
    {
         @* Предпросмотр таблицы     *@

        <RadzenDataGrid Data="@PreviewRows" 
                        TItem="Dictionary<string, string>" 
                        AllowColumnResize="true" 
                        AllowColumnReorder="true" 
                        AllowColumnPicking="true"
                        ColumnsText="колонок выбрано"
                        AllowPaging="true"
                        AllColumnsText="Все колонки"
                        ColumnsPickerAllowFiltering="true"
                        ColumnsShowingText="колонки показаны"

                        PageSize="100" >

                <HeaderTemplate>
                    <button class="btn btn-outline-secondary" @onclick="RemoveMapping"> 
                        Очистить выбранные свойства
                    </button>
                </HeaderTemplate>

            <Columns>
                @foreach (var col in ExcelColumns)
                {
                    <RadzenDataGridColumn TItem="Dictionary<string,string>" Title="@col" Property="@col">
                        <HeaderTemplate>
                            <p>@col</p>
                            <RadzenDropDown Data="AvailableEntityFields"
                                            TextProperty="Name" 
                                            AllowClear="true"
                                            AllowFiltering="true"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                            @bind-Value="ColumnMappings[col]"
                                            Placeholder="Выберите свойство...">

                                @* Кастомный шаблон для отображения элементов *@
                                    <Template Context="field">
                                        <div style="display:flex; flex-direction:column;">
                                            <span>@field.Name</span>
                                            <span style="color:gray; font-size:0.85em;">
                                                (@field.ShortType) Nullable:@(field.Nullable ? "Yes" : "No")
                                            </span>
                                        </div>
                                    </Template>  
                            </RadzenDropDown>
                        </HeaderTemplate>
                        <Template Context="data">
                            @data[col] 
                        </Template>
                    </RadzenDataGridColumn>
                }
            </Columns>
        </RadzenDataGrid>
    }

</div>
</div>
</div>